<!DOCTYPE html>
<html>
<head>
     <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">

    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="static/js/jquery.ui.touch-punch.min.js"></script>

    <!-- Popper JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>

    <!-- Latest compiled JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <link href="static/open-iconic-master/font/css/open-iconic-bootstrap.css" rel="stylesheet">

    
    <title>Musicazoo WIP</title>
    <style>
        body {
            background-color: #007474;
        }
        .jumbotron {
            padding-bottom:30px;
            padding-top:30px;
        }
        .container-fluid {
            color:white;
        }
        #reboot-div {
            display:none;
        }
        #queue{
            color:black;
        }



        .banner{
            overflow: hidden;
            white-space: nowrap;
            width:100%;
        }

        .div1 {
            display: inline-block;
            animation: marquee 30s linear infinite;
        }

        .div2 {
            display: inline-block;
            animation: marquee2 30s linear infinite;
            animation-delay: 0s;
        }

        @keyframes marquee {
            from {
                transform: translateX(0%);
            }
            to {
                transform: translateX(-100%);
            }
        }

        @keyframes marquee2 {
            from {
                transform: translateX(0%);
            }
            to {
                transform: translateX(-100%);
            }
        }



    </style>

</head>
<body>
    <div class="jumbotron">
        <h1><b>MUSICAZOO</b></h1>      
        

    <div class="banner">
        <div class="div1">&nbsp;Play it and Suffer. Play it and Suffer. Play it and Suffer. Play it and Suffer. Play it and Suffer. Play it and Suffer. Play it and Suffer. Play it and Suffer. Play it and Suffer. Play it and Suffer. Play it and Suffer.</div>
        <div class="div2">&nbsp;Play it and Suffer. Play it and Suffer. Play it and Suffer. Play it and Suffer. Play it and Suffer. Play it and Suffer. Play it and Suffer. Play it and Suffer. Play it and Suffer. Play it and Suffer. Play it and Suffer.</div>
    </div>
      
      
    </div>
    <div class="container-fluid fill">
            <p id="nowplaying" style="display: none;">Now Playing:
                <span id="playingtitle"></span> <span id="playingtime"></span>
                /<span id="playinglength"></span>
                <span id="paused">[Paused]</span>
            </p>
            <p>
                <button id="pause" class="btn btn-dark m-3">
                    <span class="oi oi-media-play"></span>
                    <span class="oi oi-media-pause"></span>
                </button>

                <span class="oi oi-volume-off"></span>
                <input type="range" min="1" max="100" value="50" class="slider" id="vol"/>
                <span class="oi oi-volume-high"></span>

            </p>

            <h3>Queue a video:</h3>
            <div class="form-inline m-4">
                <input type="text" id="youtube_id" class="form-control" placeholder="youtube search or ID">
                <button id="submit" class="btn btn-dark">Queue</button>
                <button id="suggest" class="btn btn-secondary">Search</button>
                <button id="random" style="border:0px" class="btn btn-light">Random</button>          
            </div>
            
            <ul id="suggestions">
            </ul>

            <h3>Queued items:</h3>
            <div class="m-4">
                <ul id="queue" class="m-4 list-group">
                    <li class='list-group-item'>Loading...</li>
                </ul>
            </div>
            <div id="reboot-div"><p><button id="reboot">emergency reboot</button></p></div>
    </div>
    
    <script>
        (function() {
            function json_request(cb, err, endpoint) {
                var req = new XMLHttpRequest();
                req.addEventListener("load", function() {
                    if (!this.responseText) {
                        return;
                    }
                    var json = JSON.parse(this.responseText);
                    if (json) {
                        cb(json);
                    } else {
                        err("bad json from endpoint " + endpoint);
                    }
                });
                req.addEventListener("error", function() {
                    err("xhr failed");
                });
                req.open("POST", endpoint, true);
                req.send();
            }

            function default_err(err) {
                console.log("error", err);
            }

            function left_pad(s, padchar, minlength) {
                if (s.length < minlength) {
                    return (padchar * (minlength - s.length)) + s;
                } else {
                    return s;
                }
            }

            function secs_to_hms(secs) {
                var hours = Math.floor(secs / 3600);
                var minutes = Math.floor((secs % 3600) / 60);
                var seconds = Math.floor(secs % 60);
                if (hours > 0) {
                    return hours.toString() + ":" + left_pad(minutes.toString(), "0", 2) + ":" + left_pad(seconds.toString(), "0", 2);
                } else {
                    return minutes.toString() + ":" + left_pad(seconds.toString(), "0", 2);
                }
            }
            var max_txt_name = 0;
            var random_txt = Math.floor(Math.random() * max_txt_name );
            var movediv1 = document.getElementById("div1");
            var movediv2 = document.getElementById("div2");
            //TODO: add functionality to choose random txt file and display contents in divs above 
            

            var nowplaying = document.getElementById("nowplaying");
            var playingtitle = document.getElementById("playingtitle");
            var playingtime = document.getElementById("playingtime");
            var playinglength = document.getElementById("playinglength");
            var paused = document.getElementById("paused");
            var youtube_id = document.getElementById("youtube_id");
            var submit = document.getElementById("submit");
            var queue = document.getElementById("queue");
            var suggestions = document.getElementById("suggestions");
            var suggest = document.getElementById("suggest");
            var slider = document.getElementById("vol");

            var pausebtn = document.getElementById("pause");
            var random = document.getElementById("random");

            var playlist = [];
            var slider_lock = false;
            var slider_lock_timeout;

            $( function() {
                $( "#queue" ).sortable({
                    update: function(ev, ui) {
                        reorder($("#queue").sortable("toArray"));
                    }
                });
                $( "#queue" ).disableSelection();
            } );
            function clear_suggestions() {
                suggestions.innerHTML = "";
            }

            function set_volume(vol) {
                json_request(function() {}, default_err, "setvolume?vol=" + vol);
            };

            slider.oninput = function() {
                if (slider_lock_timeout) {
                    clearTimeout(slider_lock_timeout);
                }
                slider_lock = true;
                set_volume(this.value);
                slider_lock_timeout = setTimeout(function () { slider_lock = false; }, 1000);
            } 

            random.onclick = function() {
                if (random.disabled) { return; }
                random.disabled = true;
                json_request(function() { random.disabled=false; }, function(err) { random.disabled = false; console.log(err); }, "random");
            };

            function reorder(uuids) {
                var query = "";
                for (var i = 0; i < uuids.length; i++) {
                    if (i > 0) {
                        query += "&";
                    }
                    query += "uuids=" + encodeURIComponent(uuids[i]);
                }
                json_request(function() {}, default_err, "reorder?" + query);
            };

            pausebtn.onclick = function() {
                json_request(function() {}, default_err, "pause");
            };

            function render_suggestions(results) {
                var outline = "";
                for (var i = 0; i < results.length; i++) {
                    outline += "<li><span></span><button>queue</button><button>up</button><button>down</button></li>";
                }
                suggestions.innerHTML = outline;
                for (var i = 0; i < results.length; i++) {
                    suggestions.children[i].children[0].textContent = results[i].title;
                    suggestions.children[i].children[1].onclick = function() {
                    youtube_id.value = this;
                    suggestions.innerHTML = "";
                    submit.onclick();
                    }.bind(results[i].ytid);
                }
            }

            suggest.onclick = function() {
            if (suggest.disabled) { return; }
            suggest.disabled = true;
            json_request(function(data) {
                render_suggestions(data);
                suggest.disabled = false;
            }, function(err) {
                console.log(err);
                suggest.disabled = false;
            }, "search?q=" + encodeURIComponent(youtube_id.value));
            };
            youtube_id.onkeypress = function(e) {
            if (!e) { e = window.event; }
            clear_suggestions();
            var keyCode = e.keyCode || e.which;
            if (keyCode == 13) {
                submit.onclick();
                return false;
            }
            };
            submit.onclick = function() {
            if (youtube_id.disabled) { return; }
            youtube_id.disabled = true;
            json_request(function(data) {
                youtube_id.value = "";
                youtube_id.disabled = false;
            }, function(err) {
                console.log(err);
                youtube_id.disabled = false;
            }, "enqueue?youtube_id=" + encodeURIComponent(youtube_id.value));
            };
            function delete_uuid(x) {
            json_request(function(data) {}, default_err, "delete?uuid=" + encodeURIComponent(x));
            }
            var reboot = document.getElementById("reboot");
            reboot.onclick = function() {
                json_request(function () {}, default_err, "reboot");
            };

            function arraysEqual(xs, ys) {
                if (xs.length !== ys.length) {
                    return false;
                }
                for (var i = 0; i < xs.length; ++i) {
                    if (xs[i] !== ys[i]) {
                        return false;
                    }
                }
                return true;
            }

            function lightUpdateQueue(data) {
                for (var i = 0; i < data.listing.length; i++) {
                    var span = document.getElementById(data.listing[i].uuid).children[0];
                    var ytid = data.listing[i].ytid;
                    var title = data.titles[ytid] || ytid;
                    if (!data.titles[ytid] || !data.loaded[ytid]) {
                        title += " (loading)";
                    }
                    span.innerText = title;
                }
            }

            function updateQueue(data) {
                var total = "";
                for (var i = 0; i < data.listing.length; i++) {
                    total += "<li class='list-group-item'><span></span> | <button>delete</button></li>";
                }
                queue.innerHTML = total;
                for (var i = 0; i < data.listing.length; i++) {
                    queue.children[i].id = data.listing[i].uuid;
                    var span = queue.children[i].children[0];
                    var deleter = queue.children[i].children[1];
                    var ytid = data.listing[i].ytid;
                    var title = data.titles[ytid] || ytid;
                    if (!data.titles[ytid] || !data.loaded[ytid]) {
                        title += " (loading)";
                    }
                    span.innerText = title;
                    deleter.onclick = (function() { delete_uuid(this); }).bind(data.listing[i].uuid);
                }
            }
            function refresh() {
                json_request(function(data) {
                    if (data.listing.length > 0 && data.loaded[data.listing[0].ytid]) {
                        playingtitle.textContent = data.titles[data.listing[0].ytid];
                        playingtime.textContent = secs_to_hms(data.time);
                        playinglength.textContent = secs_to_hms(data.length);
                        if (data.paused) {
                            paused.style.display = "";
                        } else {
                            paused.style.display = "none";
                        }
                        nowplaying.style.display = "";
                        pausebtn.disabled = false
                    } else {
                        nowplaying.style.display = "none";
                        pausebtn.disabled = true
                    }
                    if (data.reboot_ok) {
                        document.getElementById("reboot-div").style.display ="";
                    }

                    if (!slider_lock) {
                        slider.value = data.volume !== null ? data.volume : 50;
                    }

                    if (arraysEqual(data.listing.map(x => x.uuid), playlist.map(x => x.uuid))) {
                        lightUpdateQueue(data);
                    } else {
                        playlist = data.listing;
                        updateQueue(data);
                    }
                }, default_err, "status");
            };
            setInterval(refresh, 1000);
        })();
    </script>
</body>
</html>
